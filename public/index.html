<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SNIGEL // Competitive Intelligence Radar</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Oxanium:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deepest: #050a12;
  --bg-panel: #0a1020;
  --bg-card: #0d1528;
  --bg-elevated: #111d35;
  --accent-green: #00e5a0;
  --accent-green-dim: #00e5a033;
  --accent-green-glow: #00e5a066;
  --accent-amber: #f0a500;
  --accent-amber-dim: #f0a50033;
  --accent-blue: #38bdf8;
  --accent-blue-dim: #38bdf833;
  --accent-red: #ef4444;
  --accent-red-dim: #ef444433;
  --accent-purple: #a78bfa;
  --grid: #0f1a2e;
  --border: #1a2740;
  --border-bright: #243554;
  --text-primary: #e2e8f0;
  --text-secondary: #7a8ba5;
  --text-dim: #3e506a;
  --font-display: 'Oxanium', sans-serif;
  --font-data: 'Share Tech Mono', monospace;
  --font-body: 'Rajdhani', sans-serif;
  --scan-speed: 6s;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 14px; }
body {
  font-family: var(--font-body);
  background: var(--bg-deepest);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  background-image:
    radial-gradient(ellipse at 20% 50%, #0a1a3011 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, #00e5a006 0%, transparent 40%);
}
body::after {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, #00000008 2px, #00000008 4px);
}
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-deepest); }
::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-green-dim); }

.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 1rem 2rem; background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100; backdrop-filter: blur(12px);
}
.header-left { display: flex; align-items: center; gap: 1.5rem; }
.logo { font-family: var(--font-display); font-weight: 700; font-size: 1.6rem; letter-spacing: 0.15em; color: var(--text-primary); text-transform: uppercase; }
.logo span { color: var(--accent-green); }
.logo-sub { font-family: var(--font-data); font-size: 0.7rem; color: var(--text-dim); letter-spacing: 0.2em; text-transform: uppercase; }
.status-indicators { display: flex; gap: 1.2rem; align-items: center; }
.status-badge { display: flex; align-items: center; gap: 0.4rem; font-family: var(--font-data); font-size: 0.75rem; color: var(--text-secondary); padding: 0.3rem 0.8rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 3px; }
.status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); animation: pulse-dot 2s ease-in-out infinite; }
.status-dot.scanning { background: var(--accent-amber); box-shadow: 0 0 8px var(--accent-amber); }
@keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.header-actions { display: flex; gap: 0.8rem; }
.btn { font-family: var(--font-data); font-size: 0.75rem; padding: 0.5rem 1rem; background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border); border-radius: 3px; cursor: pointer; letter-spacing: 0.05em; text-transform: uppercase; transition: all 0.2s; }
.btn:hover { border-color: var(--accent-green); color: var(--accent-green); box-shadow: 0 0 12px var(--accent-green-dim); }

.main {
  display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto auto;
  gap: 1px; background: var(--border); max-width: 1800px; margin: 0 auto;
}
.panel { background: var(--bg-panel); padding: 1.5rem; position: relative; overflow: hidden; }
.panel::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--accent-green-dim), transparent); }
.panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.2rem; }
.panel-title { font-family: var(--font-display); font-weight: 600; font-size: 0.85rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-secondary); display: flex; align-items: center; gap: 0.6rem; }
.panel-title .icon { width: 8px; height: 8px; border: 1.5px solid var(--accent-green); border-radius: 1px; transform: rotate(45deg); }
.panel-count { font-family: var(--font-data); font-size: 0.7rem; color: var(--text-dim); }

.radar-panel { grid-column: 1; grid-row: 1; display: flex; flex-direction: column; align-items: center; min-height: 520px; }
.radar-container { position: relative; width: 460px; height: 460px; }
#radarCanvas { width: 100%; height: 100%; }
.radar-legend { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 1rem; justify-content: center; }
.legend-item { display: flex; align-items: center; gap: 0.35rem; font-family: var(--font-data); font-size: 0.65rem; color: var(--text-dim); cursor: pointer; transition: color 0.2s; }
.legend-item:hover { color: var(--text-secondary); }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; }

.feed-panel { grid-column: 2; grid-row: 1; min-height: 520px; }
.feed-tabs { display: flex; gap: 0; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 3px; overflow: hidden; }
.feed-tab { flex: 1; font-family: var(--font-data); font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; padding: 0.5rem; text-align: center; background: var(--bg-card); color: var(--text-dim); border: none; cursor: pointer; transition: all 0.2s; border-right: 1px solid var(--border); }
.feed-tab:last-child { border-right: none; }
.feed-tab.active { background: var(--accent-green); color: var(--bg-deepest); font-weight: 600; }
.feed-tab:not(.active):hover { color: var(--text-secondary); background: var(--bg-elevated); }
.feed-list { display: flex; flex-direction: column; gap: 2px; max-height: 430px; overflow-y: auto; padding-right: 4px; }
.feed-item { display: grid; grid-template-columns: auto 1fr auto; gap: 0.8rem; padding: 0.7rem 0.8rem; background: var(--bg-card); border: 1px solid transparent; border-radius: 3px; cursor: pointer; transition: all 0.2s; align-items: start; text-decoration: none; color: inherit; }
.feed-item:hover { border-color: var(--border-bright); background: var(--bg-elevated); }
.feed-item.new { border-left: 2px solid var(--accent-green); animation: feed-flash 2s ease-out; }
@keyframes feed-flash { 0% { background: var(--accent-green-dim); } 100% { background: var(--bg-card); } }
.feed-competitor-tag { font-family: var(--font-data); font-size: 0.6rem; padding: 0.2rem 0.5rem; border-radius: 2px; letter-spacing: 0.05em; text-transform: uppercase; white-space: nowrap; margin-top: 2px; }
.feed-title { font-family: var(--font-body); font-weight: 500; font-size: 0.85rem; color: var(--text-primary); line-height: 1.3; }
.feed-source { font-family: var(--font-data); font-size: 0.6rem; color: var(--text-dim); margin-top: 0.2rem; }
.feed-time { font-family: var(--font-data); font-size: 0.6rem; color: var(--text-dim); white-space: nowrap; margin-top: 2px; }
.feed-empty { text-align: center; padding: 3rem 1rem; color: var(--text-dim); font-family: var(--font-data); font-size: 0.8rem; }
.feed-empty .spinner { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
@keyframes spin { to { transform: rotate(360deg); } }

.competitors-panel { grid-column: 1 / -1; grid-row: 2; }
.competitors-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.8rem; }
.competitor-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1.2rem; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
.competitor-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: var(--card-accent, var(--accent-green)); opacity: 0; transition: opacity 0.3s; }
.competitor-card:hover { border-color: var(--border-bright); transform: translateY(-2px); box-shadow: 0 4px 20px #00000040; }
.competitor-card:hover::after { opacity: 1; }
.competitor-card.expanded { grid-column: 1 / -1; }
.card-top { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.8rem; }
.card-name { font-family: var(--font-display); font-weight: 600; font-size: 1.05rem; color: var(--text-primary); letter-spacing: 0.05em; }
.card-country { font-family: var(--font-data); font-size: 0.65rem; color: var(--text-dim); margin-top: 0.15rem; }
.card-threat { font-family: var(--font-data); font-size: 0.6rem; padding: 0.2rem 0.6rem; border-radius: 2px; letter-spacing: 0.05em; text-transform: uppercase; }
.threat-high { background: var(--accent-red-dim); color: var(--accent-red); border: 1px solid #ef444444; }
.threat-medium { background: var(--accent-amber-dim); color: var(--accent-amber); border: 1px solid #f0a50044; }
.threat-low { background: var(--accent-blue-dim); color: var(--accent-blue); border: 1px solid #38bdf844; }
.card-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; margin-bottom: 0.8rem; }
.card-stat { background: var(--bg-panel); padding: 0.5rem; border-radius: 3px; }
.card-stat-label { font-family: var(--font-data); font-size: 0.55rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.2rem; }
.card-stat-value { font-family: var(--font-display); font-weight: 600; font-size: 0.95rem; color: var(--text-primary); }
.card-focus { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.8rem; }
.focus-tag { font-family: var(--font-data); font-size: 0.6rem; padding: 0.15rem 0.5rem; border-radius: 2px; background: var(--bg-elevated); color: var(--text-secondary); border: 1px solid var(--border); }
.card-details { display: none; margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid var(--border); }
.competitor-card.expanded .card-details { display: block; }
.swot-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.8rem; }
.swot-cell { padding: 0.6rem; border-radius: 3px; font-size: 0.75rem; line-height: 1.4; }
.swot-cell h4 { font-family: var(--font-data); font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.4rem; }
.swot-strength { background: #00e5a00d; border: 1px solid #00e5a022; }
.swot-strength h4 { color: var(--accent-green); }
.swot-weakness { background: #ef44440d; border: 1px solid #ef444422; }
.swot-weakness h4 { color: var(--accent-red); }
.swot-opportunity { background: #38bdf80d; border: 1px solid #38bdf822; }
.swot-opportunity h4 { color: var(--accent-blue); }
.swot-threat-cell { background: #f0a5000d; border: 1px solid #f0a50022; }
.swot-threat-cell h4 { color: var(--accent-amber); }
.mini-event { display: flex; gap: 0.6rem; padding: 0.3rem 0; font-size: 0.75rem; border-bottom: 1px solid var(--border); }
.mini-event:last-child { border-bottom: none; }
.mini-event-date { font-family: var(--font-data); font-size: 0.6rem; color: var(--text-dim); white-space: nowrap; min-width: 60px; }
.card-signals { margin-top: 0.8rem; padding-top: 0.8rem; border-top: 1px solid var(--border); }
.card-signals-header { font-family: var(--font-data); font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.4rem; }
.card-signals-header .signal-count { color: var(--accent-green); }
.card-signal { display: flex; gap: 0.6rem; padding: 0.4rem 0; border-bottom: 1px solid var(--border); align-items: start; }
.card-signal:last-child { border-bottom: none; }
.card-signal-time { font-family: var(--font-data); font-size: 0.55rem; color: var(--text-dim); white-space: nowrap; min-width: 50px; margin-top: 2px; }
.card-signal-text { flex: 1; }
.card-signal-title { font-family: var(--font-body); font-size: 0.8rem; color: var(--text-primary); line-height: 1.3; }
.card-signal-title a { color: inherit; text-decoration: none; }
.card-signal-title a:hover { color: var(--accent-green); }
.card-signal-source { font-family: var(--font-data); font-size: 0.55rem; color: var(--text-dim); margin-top: 0.15rem; }
.card-no-signals { font-family: var(--font-data); font-size: 0.7rem; color: var(--text-dim); padding: 0.6rem 0; font-style: italic; }

.spider-panel { grid-column: 1; grid-row: 3; min-height: 420px; }
#spiderCanvas { width: 100%; max-width: 450px; height: 380px; display: block; margin: 0 auto; }
.spider-controls { display: flex; flex-wrap: wrap; gap: 0.4rem; justify-content: center; margin-top: 0.8rem; }
.spider-toggle { font-family: var(--font-data); font-size: 0.6rem; padding: 0.3rem 0.6rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 2px; color: var(--text-dim); cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.05em; }
.spider-toggle.active { border-color: var(--toggle-color, var(--accent-green)); color: var(--toggle-color, var(--accent-green)); background: color-mix(in srgb, var(--toggle-color, var(--accent-green)) 10%, transparent); }
.spider-toggle:hover:not(.active) { border-color: var(--border-bright); color: var(--text-secondary); }

.timeline-panel { grid-column: 2; grid-row: 3; min-height: 420px; }
.timeline-list { position: relative; padding-left: 1.2rem; max-height: 380px; overflow-y: auto; }
.timeline-list::before { content: ''; position: absolute; left: 4px; top: 0; bottom: 0; width: 1px; background: linear-gradient(var(--border-bright), var(--border), transparent); }
.timeline-item { position: relative; padding: 0.6rem 0 0.6rem 1rem; border-bottom: 1px solid var(--border); }
.timeline-item:last-child { border-bottom: none; }
.timeline-item::before { content: ''; position: absolute; left: -1.2rem; top: 0.9rem; width: 9px; height: 9px; border-radius: 50%; background: var(--event-color, var(--accent-green)); border: 2px solid var(--bg-panel); box-shadow: 0 0 6px var(--event-color, var(--accent-green-dim)); }
.timeline-date { font-family: var(--font-data); font-size: 0.6rem; color: var(--text-dim); letter-spacing: 0.05em; }
.timeline-company { font-family: var(--font-display); font-weight: 600; font-size: 0.8rem; color: var(--text-primary); margin: 0.15rem 0; }
.timeline-text { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4; }
.timeline-tag { display: inline-block; font-family: var(--font-data); font-size: 0.55rem; padding: 0.1rem 0.4rem; border-radius: 2px; margin-top: 0.3rem; text-transform: uppercase; letter-spacing: 0.05em; }
.tag-ma { background: var(--accent-purple); color: #fff; opacity: 0.8; }
.tag-contract { background: var(--accent-green); color: var(--bg-deepest); opacity: 0.8; }
.tag-expansion { background: var(--accent-blue); color: var(--bg-deepest); opacity: 0.8; }
.tag-investment { background: var(--accent-amber); color: var(--bg-deepest); opacity: 0.8; }
.tag-product { background: #64748b; color: #fff; opacity: 0.8; }

.loading-overlay { position: fixed; inset: 0; background: var(--bg-deepest); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.8s ease; }
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.loading-radar { width: 120px; height: 120px; border-radius: 50%; border: 1px solid var(--border); position: relative; margin-bottom: 2rem; }
.loading-radar::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(from 0deg, transparent 0deg, var(--accent-green-dim) 30deg, transparent 60deg); animation: spin var(--scan-speed) linear infinite; }
.loading-text { font-family: var(--font-data); font-size: 0.8rem; color: var(--accent-green); letter-spacing: 0.3em; text-transform: uppercase; animation: blink-text 1.5s step-end infinite; }
@keyframes blink-text { 50% { opacity: 0; } }

/* Brief Modal */
.brief-overlay { position: fixed; inset: 0; background: #000000cc; z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.brief-overlay.visible { display: flex; }
.brief-modal { background: var(--bg-panel); border: 1px solid var(--border-bright); border-radius: 6px; width: 90%; max-width: 820px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px #000000aa, 0 0 40px var(--accent-green-dim); }
.brief-header { display: flex; align-items: center; justify-content: space-between; padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border); }
.brief-header-left { display: flex; align-items: center; gap: 0.8rem; }
.brief-header h2 { font-family: var(--font-display); font-weight: 600; font-size: 1rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); }
.brief-model-tag { font-family: var(--font-data); font-size: 0.6rem; padding: 0.2rem 0.5rem; border-radius: 2px; background: var(--accent-green-dim); color: var(--accent-green); border: 1px solid var(--accent-green); letter-spacing: 0.05em; }
.brief-close { background: none; border: 1px solid var(--border); color: var(--text-dim); font-family: var(--font-data); font-size: 0.8rem; padding: 0.3rem 0.8rem; border-radius: 3px; cursor: pointer; transition: all 0.2s; }
.brief-close:hover { border-color: var(--accent-red); color: var(--accent-red); }
.brief-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
.brief-content { font-family: var(--font-body); font-size: 0.9rem; line-height: 1.7; color: var(--text-primary); }
.brief-content h2 { font-family: var(--font-display); font-weight: 600; font-size: 1rem; letter-spacing: 0.1em; color: var(--accent-green); margin: 1.5rem 0 0.6rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--border); }
.brief-content h2:first-child { margin-top: 0; }
.brief-content ul { padding-left: 1.2rem; margin: 0.4rem 0; }
.brief-content li { margin-bottom: 0.4rem; color: var(--text-secondary); }
.brief-content strong { color: var(--text-primary); font-weight: 600; }
.brief-content p { margin: 0.5rem 0; color: var(--text-secondary); }
.brief-cursor { display: inline-block; width: 2px; height: 1em; background: var(--accent-green); margin-left: 2px; vertical-align: text-bottom; animation: blink-text 0.8s step-end infinite; }
.brief-footer { padding: 0.8rem 1.5rem; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.brief-usage { font-family: var(--font-data); font-size: 0.65rem; color: var(--text-dim); }
.brief-status { font-family: var(--font-data); font-size: 0.7rem; color: var(--accent-green); display: flex; align-items: center; gap: 0.4rem; }
.brief-status .spinner { width: 12px; height: 12px; border: 1.5px solid var(--border); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 0.8s linear infinite; }
.brief-history-list { padding: 0.5rem 0; }
.brief-history-item { display: flex; align-items: start; gap: 0.8rem; padding: 0.6rem 0.8rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.4rem; cursor: pointer; transition: all 0.2s; }
.brief-history-item:hover { border-color: var(--accent-green); background: var(--bg-elevated); }
.brief-history-item.active { border-color: var(--accent-green); border-left: 3px solid var(--accent-green); }
.brief-history-date { font-family: var(--font-data); font-size: 0.65rem; color: var(--accent-green); white-space: nowrap; min-width: 80px; }
.brief-history-preview { font-family: var(--font-body); font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4; flex: 1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
.brief-history-tokens { font-family: var(--font-data); font-size: 0.55rem; color: var(--text-dim); white-space: nowrap; }
.btn-brief { background: linear-gradient(135deg, var(--accent-green-dim), #00e5a011); border-color: var(--accent-green); color: var(--accent-green); }
.btn-brief:hover { background: var(--accent-green); color: var(--bg-deepest); box-shadow: 0 0 20px var(--accent-green-dim); }
.btn-sources { background: linear-gradient(135deg, var(--accent-blue-dim), #38bdf811); border-color: var(--accent-blue); color: var(--accent-blue); }
.btn-sources:hover { background: var(--accent-blue); color: var(--bg-deepest); box-shadow: 0 0 20px var(--accent-blue-dim); }

/* Sources Modal */
.sources-overlay { position: fixed; inset: 0; background: #000000cc; z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.sources-overlay.visible { display: flex; }
.sources-modal { background: var(--bg-panel); border: 1px solid var(--border-bright); border-radius: 6px; width: 92%; max-width: 960px; max-height: 88vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px #000000aa, 0 0 40px var(--accent-blue-dim); }
.sources-header { display: flex; align-items: center; justify-content: space-between; padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border); }
.sources-header-left { display: flex; align-items: center; gap: 0.8rem; }
.sources-header h2 { font-family: var(--font-display); font-weight: 600; font-size: 1rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); }
.sources-close { background: none; border: 1px solid var(--border); color: var(--text-dim); font-family: var(--font-data); font-size: 0.8rem; padding: 0.3rem 0.8rem; border-radius: 3px; cursor: pointer; transition: all 0.2s; }
.sources-close:hover { border-color: var(--accent-red); color: var(--accent-red); }
.sources-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
.sources-section { margin-bottom: 1.5rem; }
.sources-section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.8rem; }
.sources-section-title { font-family: var(--font-display); font-weight: 600; font-size: 0.85rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--accent-blue); }
.sources-count { font-family: var(--font-data); font-size: 0.65rem; color: var(--text-dim); }
.source-group { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; overflow: hidden; }
.source-group-header { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 0.8rem; cursor: pointer; transition: background 0.2s; }
.source-group-header:hover { background: var(--bg-elevated); }
.source-group-name { font-family: var(--font-body); font-weight: 600; font-size: 0.85rem; color: var(--text-primary); }
.source-group-meta { font-family: var(--font-data); font-size: 0.6rem; color: var(--text-dim); }
.source-group-actions { display: flex; gap: 0.4rem; }
.source-feed-list { border-top: 1px solid var(--border); display: none; }
.source-group.expanded .source-feed-list { display: block; }
.source-feed { display: flex; align-items: center; gap: 0.6rem; padding: 0.4rem 0.8rem 0.4rem 1.2rem; border-bottom: 1px solid var(--border); font-family: var(--font-data); font-size: 0.65rem; color: var(--text-secondary); }
.source-feed:last-child { border-bottom: none; }
.source-feed-url { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.source-btn { font-family: var(--font-data); font-size: 0.6rem; padding: 0.2rem 0.5rem; border-radius: 2px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.source-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
.source-btn.danger:hover { border-color: var(--accent-red); color: var(--accent-red); }
.source-btn.primary { border-color: var(--accent-green); color: var(--accent-green); }
.source-btn.primary:hover { background: var(--accent-green); color: var(--bg-deepest); }
.source-btn.ai { border-color: var(--accent-purple); color: var(--accent-purple); }
.source-btn.ai:hover { background: var(--accent-purple); color: #fff; }
.source-add-row { display: flex; gap: 0.4rem; padding: 0.6rem 0.8rem; }
.source-input { flex: 1; font-family: var(--font-data); font-size: 0.7rem; padding: 0.4rem 0.6rem; background: var(--bg-deepest); border: 1px solid var(--border); border-radius: 3px; color: var(--text-primary); outline: none; }
.source-input:focus { border-color: var(--accent-blue); }
.source-input::placeholder { color: var(--text-dim); }
.sources-footer { padding: 0.8rem 1.5rem; border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.sources-footer-left { display: flex; gap: 0.6rem; align-items: center; }
.sources-status { font-family: var(--font-data); font-size: 0.7rem; color: var(--text-dim); }
/* AI Suggestions */
.suggest-list { margin-top: 0.8rem; }
.suggest-item { display: flex; align-items: start; gap: 0.8rem; padding: 0.7rem 0.8rem; background: var(--bg-card); border: 1px solid var(--accent-purple); border-left: 3px solid var(--accent-purple); border-radius: 4px; margin-bottom: 0.4rem; }
.suggest-item-body { flex: 1; }
.suggest-item-meta { font-family: var(--font-data); font-size: 0.6rem; color: var(--accent-purple); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.2rem; }
.suggest-item-url { font-family: var(--font-data); font-size: 0.65rem; color: var(--text-secondary); word-break: break-all; margin-bottom: 0.2rem; }
.suggest-item-reason { font-family: var(--font-body); font-size: 0.8rem; color: var(--text-dim); line-height: 1.4; }
.suggest-item-actions { display: flex; flex-direction: column; gap: 0.3rem; flex-shrink: 0; }
.suggest-spinner { display: flex; align-items: center; gap: 0.5rem; padding: 1rem; color: var(--accent-purple); font-family: var(--font-data); font-size: 0.75rem; }
.suggest-spinner .spinner { width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent-purple); border-radius: 50%; animation: spin 0.8s linear infinite; }

@media (max-width: 1100px) {
  .main { grid-template-columns: 1fr; }
  .radar-panel, .feed-panel, .competitors-panel, .spider-panel, .timeline-panel { grid-column: 1; }
  .competitors-panel, .spider-panel, .timeline-panel { grid-row: auto; }
  .competitor-card.expanded { grid-column: span 1; }
  .radar-container { width: 340px; height: 340px; }
}
@media print {
  body { background: #fff !important; color: #000 !important; }
  body::after { display: none !important; }
  .header, .main, .sources-overlay, .loading-overlay { display: none !important; }
  .brief-overlay { position: static !important; display: block !important; background: none !important; backdrop-filter: none !important; }
  .brief-overlay.visible { display: block !important; }
  .brief-modal { width: 100% !important; max-width: 100% !important; max-height: none !important; border: none !important; box-shadow: none !important; background: #fff !important; }
  .brief-header { border-bottom: 2px solid #000 !important; }
  .brief-header, .brief-header h2, .brief-model-tag { color: #000 !important; background: none !important; border-color: #000 !important; }
  .brief-close, #briefHistoryBtn, #briefPrintBtn { display: none !important; }
  .brief-body { overflow: visible !important; }
  .brief-content, .brief-content h2, .brief-content li, .brief-content p, .brief-content strong { color: #000 !important; }
  .brief-content h2 { color: #333 !important; border-bottom: 1px solid #ccc !important; }
  .brief-footer { border-top: 1px solid #ccc !important; }
  .brief-usage, .brief-status { color: #666 !important; }
  .brief-cursor { display: none !important; }
}
@media (max-width: 600px) {
  .header { padding: 0.8rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
  .panel { padding: 1rem; }
  .competitors-grid { grid-template-columns: 1fr; }
  .radar-container { width: 280px; height: 280px; }
}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-radar"></div>
  <div class="loading-text">Initializing radar</div>
</div>

<header class="header">
  <div class="header-left">
    <div>
      <div class="logo">SNIGEL <span>//</span> RADAR</div>
      <div class="logo-sub">Competitive Intelligence System</div>
    </div>
    <div class="status-indicators">
      <div class="status-badge">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">ONLINE</span>
      </div>
      <div class="status-badge">
        <span id="lastScan">LAST SCAN: --:--</span>
      </div>
      <div class="status-badge">
        <span id="feedCount">0 SIGNALS</span>
      </div>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn btn-brief" id="briefBtn">AI BRIEF</button>
    <button class="btn btn-sources" id="sourcesBtn">SOURCES</button>
    <button class="btn" id="scanBtn">SCAN NOW</button>
    <button class="btn" id="viewToggle">GRID VIEW</button>
  </div>
</header>

<main class="main">
  <section class="panel radar-panel">
    <div class="panel-header">
      <div class="panel-title"><div class="icon"></div>Threat Radar</div>
      <div class="panel-count">Proximity = competitive overlap</div>
    </div>
    <div class="radar-container"><canvas id="radarCanvas"></canvas></div>
    <div class="radar-legend" id="radarLegend"></div>
  </section>

  <section class="panel feed-panel">
    <div class="panel-header">
      <div class="panel-title"><div class="icon"></div>Live Intelligence Feed</div>
      <div class="panel-count" id="feedItemCount">Loading...</div>
    </div>
    <div class="feed-tabs" id="feedTabs"></div>
    <div class="feed-list" id="feedList"></div>
  </section>

  <section class="panel competitors-panel">
    <div class="panel-header">
      <div class="panel-title"><div class="icon"></div>Competitor Profiles</div>
      <div class="panel-count">Click to expand SWOT analysis</div>
    </div>
    <div class="competitors-grid" id="competitorsGrid"></div>
  </section>

  <section class="panel spider-panel">
    <div class="panel-header">
      <div class="panel-title"><div class="icon"></div>Capability Comparison</div>
    </div>
    <canvas id="spiderCanvas"></canvas>
    <div class="spider-controls" id="spiderControls"></div>
  </section>

  <section class="panel timeline-panel">
    <div class="panel-header">
      <div class="panel-title"><div class="icon"></div>Strategic Event Timeline</div>
      <div class="panel-count">Key competitive moves</div>
    </div>
    <div class="timeline-list" id="timelineList"></div>
  </section>
</main>

<!-- Brief Modal -->
<div class="brief-overlay" id="briefOverlay">
  <div class="brief-modal">
    <div class="brief-header">
      <div class="brief-header-left">
        <h2>Intelligence Brief</h2>
        <span class="brief-model-tag">SONNET 4.5</span>
      </div>
      <div style="display:flex;gap:0.5rem;">
        <button class="source-btn" id="briefHistoryBtn">HISTORY</button>
        <button class="source-btn primary" id="briefPrintBtn">PRINT PDF</button>
        <button class="brief-close" id="briefClose">ESC</button>
      </div>
    </div>
    <div class="brief-body">
      <div class="brief-content" id="briefContent"></div>
    </div>
    <div class="brief-footer">
      <div class="brief-status" id="briefStatus"></div>
      <div class="brief-usage" id="briefUsage"></div>
    </div>
  </div>
</div>

<!-- Sources Modal -->
<div class="sources-overlay" id="sourcesOverlay">
  <div class="sources-modal">
    <div class="sources-header">
      <div class="sources-header-left">
        <h2>Feed Sources</h2>
        <span class="brief-model-tag" style="background:var(--accent-blue-dim);color:var(--accent-blue);border-color:var(--accent-blue);">EDITABLE</span>
      </div>
      <button class="sources-close" id="sourcesClose">ESC</button>
    </div>
    <div class="sources-body" id="sourcesBody"></div>
    <div class="sources-footer">
      <div class="sources-footer-left">
        <button class="source-btn ai" id="suggestBtn">AI SUGGEST NEW SOURCES</button>
        <span class="sources-status" id="sourcesStatus"></span>
      </div>
      <button class="source-btn primary" id="addCompetitorBtn">+ ADD COMPETITOR</button>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════
   SANITIZATION UTILITY
   ═══════════════════════════════════════════ */
function esc(str) {
  const div = document.createElement('div');
  div.textContent = String(str || '');
  return div.innerHTML;
}

function createEl(tag, attrs, children) {
  const el = document.createElement(tag);
  if (attrs) {
    Object.entries(attrs).forEach(([k, v]) => {
      if (k === 'className') el.className = v;
      else if (k === 'style' && typeof v === 'object') Object.assign(el.style, v);
      else if (k.startsWith('data')) el.setAttribute(k.replace(/([A-Z])/g, '-$1').toLowerCase(), v);
      else el.setAttribute(k, v);
    });
  }
  if (children) {
    if (typeof children === 'string') el.textContent = children;
    else if (Array.isArray(children)) children.forEach(c => { if (c) el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); });
    else el.appendChild(children);
  }
  return el;
}

/* ═══════════════════════════════════════════
   DATA
   ═══════════════════════════════════════════ */
const COMPETITORS = {
  nfm: { name:'NFM Group', country:'Norway', flag:'NO', founded:1996, revenue:'243 MEUR', employees:'3 400+', hq:'Ski, Norway', threat:'high', color:'#ef4444', focus:['Carry Systems','Ballistic','Clothing','Camouflage'], channels:'B2G/tenders', radarAngle:25, radarDist:0.35,
    capabilities:{breadth:9,scale:10,certs:8,price:2,reach:8,innovation:8},
    swot:{s:'Multi-system portfolio (THOR, SKJOLD, GARM), 7 production facilities, ISO 9001/14001, SA8000. Acquired Paul Boyé (2025).',w:'High portfolio complexity, tender-dependent. Budget volatility risk.',o:'European defense consolidation. M&A to expand capabilities further.',t:'Competition from larger system houses (Mehler). National buy-national policies.'},
    timeline:[{date:'1996',text:'Founded by ex-soldiers'},{date:'2020s',text:'European production/sales expansion'},{date:'2025-10',text:'Acquires Paul Boyé (France) 100%'}]},
  mehler: { name:'Mehler Systems', country:'Germany', flag:'DE', founded:1986, revenue:'Billions (est.)', employees:'1 600+', hq:'Fulda, Germany', threat:'high', color:'#dc2626', focus:['Ballistic Protection','Carry Systems','Tactical Clothing','Platform Ballistics'], channels:'B2G/programs', radarAngle:75, radarDist:0.45,
    capabilities:{breadth:10,scale:10,certs:7,price:2,reach:9,innovation:9},
    swot:{s:'Industrial scale (200K plates, >1M vests/year). Includes Lindnerhof + UF PRO. MOBAST program.',w:'Less soft-goods direct comparison. Program-dependent cyclicality.',o:'European rearmament. Acquired Stilmotor SXP (2025).',t:'Nationalized supply chains. Competition from NFM.'},
    timeline:[{date:'1986',text:'Founded as Mehler Vario System'},{date:'2023',text:'Brand consolidation under Mehler Systems'},{date:'2025',text:'Stilmotor SXP acquired; 6200 sqm new production'}]},
  lindnerhof: { name:'Lindnerhof Taktik', country:'Germany', flag:'DE', founded:2006, revenue:'>10 MEUR (2016)', employees:'57', hq:'Lenggries, Germany', threat:'high', color:'#f97316', focus:['Plate Carriers','Pouches','Modular Gear','Belts'], channels:'Dealer + gov', radarAngle:10, radarDist:0.25,
    capabilities:{breadth:7,scale:6,certs:5,price:2,reach:7,innovation:7},
    swot:{s:'Premium modular platform. DACH leader. Part of Mehler Systems.',w:'Price info less transparent. Dealer/government dependent.',o:'Synergies within Mehler for large programs.',t:'Direct competition from Snigel. TT in commercial.'},
    timeline:[{date:'2006',text:'Founded by Josef "Seppo" Sixt'},{date:'2011',text:'Quick release system patent (LT025)'},{date:'2017',text:'Joins Mehler Systems Group'}]},
  sacci: { name:'Sacci AB', country:'Sweden', flag:'SE', founded:1992, revenue:'~150 MSEK', employees:'25-28', hq:'Borlänge, Sweden', threat:'medium', color:'#f0a500', focus:['Medical Bags','Tactical Carry','Radio Pouches','Private Label'], channels:'B2B/B2G', radarAngle:260, radarDist:0.42,
    capabilities:{breadth:6,scale:5,certs:8,price:2,reach:4,innovation:5},
    swot:{s:'Haglöfs heritage. Swedish prototyping + EU/Asia production. ISO 9001/14001.',w:'Lower international brand. Pricing less transparent.',o:'"Swedish-produced" differentiator. M&A-driven capacity growth.',t:'Larger system houses and brands with retail channels.'},
    timeline:[{date:'1914',text:'Origins in Haglöfs manufacturing'},{date:'1992',text:'Sacci AB name adopted'},{date:'2025-04',text:'Strategic acquisition for capacity'}]},
  savotta: { name:'Savotta', country:'Finland', flag:'FI', founded:1955, revenue:'14.5 MEUR', employees:'~53 FI +120 EE', hq:'Karstula, Finland', threat:'medium', color:'#eab308', focus:['Military Packs','Outdoor Dual-use','Sustainment','Tents'], channels:'Dual: B2G + D2C', radarAngle:340, radarDist:0.38,
    capabilities:{breadth:6,scale:5,certs:9,price:5,reach:5,innovation:5},
    swot:{s:'Robust dual-use. ISO/AQAP/NATO CAGE. 97% EU materials.',w:'Narrower ballistic range. Regional dealer limits.',o:'M23 framework 37 MEUR. Rite Ventures capital.',t:'Premium pack competition from TT/Snigel/Lindnerhof.'},
    timeline:[{date:'1955',text:'Founded'},{date:'1960s',text:'Finnish Defence Forces supplier'},{date:'2025-04',text:'Rite Ventures minority + M23 (37 MEUR)'}]},
  taiga: { name:'Taiga AB', country:'Sweden', flag:'SE', founded:1982, revenue:'~156 MSEK', employees:'~30', hq:'Varberg, Sweden', threat:'medium', color:'#a3e635', focus:['Tactical Clothing','Uniforms','IR/Camouflage','CBRN'], channels:'B2G/B2B', radarAngle:155, radarDist:0.48,
    capabilities:{breadth:6,scale:5,certs:8,price:2,reach:5,innovation:7},
    swot:{s:'EU manufacturing. Strong test infrastructure. ISO/CE/OEKO-TEX.',w:'Smaller carry/ballistic overlap with Snigel.',o:'Uniform system demand. CBRN/IR requirements.',t:'UF PRO/Mehler and NFM GARM competition.'},
    timeline:[{date:'1982',text:'Founded for advanced workwear'},{date:'1983',text:'Gore-Tex licensee (Scandinavia)'},{date:'1995',text:'First ISO 9001 in industry'}]},
  tasmanian_tiger: { name:'Tasmanian Tiger', country:'Germany', flag:'DE', founded:1999, revenue:'Tatonka (~1000 emp)', employees:'~1 000 group', hq:'Dasing, Germany', threat:'medium', color:'#fb923c', focus:['Backpacks','Pouches','Medical Gear','IRR Equipment'], channels:'Dealer/retail global', radarAngle:330, radarDist:0.33,
    capabilities:{breadth:7,scale:8,certs:7,price:8,reach:8,innovation:6},
    swot:{s:'Open Factory transparency. SA8000. Public EUR pricing. Global dealers.',w:'Less custom system dev. B2G local content risk.',o:'Civilian/LE markets. Fast product expansion.',t:'Snigel/Lindnerhof in modular gear. Dealer price pressure.'},
    timeline:[{date:'1989',text:'Tatonka factory in Vietnam (Mountech)'},{date:'1999',text:'Tasmanian Tiger brand launched'},{date:'2011',text:'SA8000 + Open Factory'}]},
  equipnor: { name:'Equipnor AB', country:'Sweden', flag:'SE', founded:2008, revenue:'~338 MSEK', employees:'~10', hq:'Stockholm, Sweden', threat:'low', color:'#38bdf8', focus:['System Integration','SEA/AIR/LAND','Partner Products'], channels:'Gov procurement', radarAngle:210, radarDist:0.65,
    capabilities:{breadth:7,scale:4,certs:8,price:2,reach:3,innovation:3},
    swot:{s:'Government relationships. Procurement expertise. ISO. NFM Group.',w:'Reseller/integrator role vs own products.',o:'Swedish defense growth. Cross-domain packaging.',t:'Manufacturers building direct channels.'},
    timeline:[{date:'2008',text:'Established'},{date:'2021',text:'Acquires SafeNor AS (NFM Group)'},{date:'2024',text:'Strong revenue growth'}]},
  ptd: { name:'PTD Group', country:'Denmark', flag:'DK', founded:1985, revenue:'~11 MDKK', employees:'16', hq:'Svenstrup, Denmark', threat:'low', color:'#60a5fa', focus:['System Integration','C4ISR','Sensors/Optics','Navigation'], channels:'Project/tenders', radarAngle:195, radarDist:0.72,
    capabilities:{breadth:8,scale:3,certs:3,price:2,reach:5,innovation:5},
    swot:{s:'Integration capability. Broad tech portfolio. Profitable.',w:'Limited soft-goods comparability. Low cert transparency.',o:'Nordic defense investments for turn-key solutions.',t:'More actors entering defense market.'},
    timeline:[{date:'1985',text:'Founded'},{date:'2024-09',text:'New HQ + new leadership'},{date:'2025',text:'Improved profitability'}]}
};

const SNIGEL = { name:'SNIGEL', color:'#00e5a0', capabilities:{breadth:7,scale:4,certs:4,price:5,reach:5,innovation:8} };
const CAPABILITY_LABELS = { breadth:'Product Breadth', scale:'Production Scale', certs:'Certifications', price:'Price Transparency', reach:'Geographic Reach', innovation:'Innovation' };

const STRATEGIC_EVENTS = [
  {date:'2025-10',company:'NFM Group',text:'Acquires Paul Boyé (French manufacturer) 100%. Strengthens European presence.',tag:'ma',color:'#a78bfa'},
  {date:'2025-04',company:'Savotta',text:'Rite Ventures minority stake. M23 equipment framework 37 MEUR with Finnish Defence.',tag:'investment',color:'#eab308'},
  {date:'2025-04',company:'Sacci AB',text:'Strategic acquisition to strengthen Swedish manufacturing capacity.',tag:'ma',color:'#a78bfa'},
  {date:'2025-03',company:'SNIGEL',text:'eEquity leads investment; ~50% stake acquired. Targets 1 BnSEK international growth.',tag:'investment',color:'#f0a500'},
  {date:'2025',company:'Mehler Systems',text:'Acquires Stilmotor SXP. New 6200 sqm production hall in Zrenjanin.',tag:'expansion',color:'#38bdf8'},
  {date:'2025',company:'Mehler Systems',text:'MOBAST deliveries to Bundeswehr. Named Germany Top 100 Innovators.',tag:'contract',color:'#00e5a0'},
  {date:'2024-09',company:'PTD Group',text:'New HQ. New Managing Director + two Business Development Managers.',tag:'expansion',color:'#38bdf8'},
  {date:'2024',company:'Equipnor',text:'Strong revenue growth. Deepens Spiritus Systems collaboration.',tag:'expansion',color:'#38bdf8'},
  {date:'2024',company:'SNIGEL',text:'Revenue ~365 MSEK. Major European contracts. ~25 employees, Farsta HQ.',tag:'contract',color:'#00e5a0'},
  {date:'2023',company:'Mehler Systems',text:'Brand consolidation under unified Mehler Systems identity.',tag:'product',color:'#64748b'},
  {date:'2022',company:'SNIGEL',text:'Breakthrough order pushes revenue >500 MSEK. International acceleration.',tag:'contract',color:'#00e5a0'},
  {date:'2022',company:'Lindnerhof',text:'International expansion: 57 employees, new warehouse.',tag:'expansion',color:'#38bdf8'},
  {date:'2021',company:'Equipnor',text:'Acquires SafeNor AS (NFM Group Scandinavia consolidation).',tag:'ma',color:'#a78bfa'},
  {date:'2017',company:'Lindnerhof',text:'Becomes part of Mehler Systems Group.',tag:'ma',color:'#a78bfa'},
];

/* ═══════════════════════════════════════════
   STATE
   ═══════════════════════════════════════════ */
let feedData = { competitors: {}, industry: [] };
let currentFilter = 'all';
let expandedCard = null;
let spiderSelected = ['nfm', 'lindnerhof', 'tasmanian_tiger'];
let radarAnimFrame = null;
let radarAngle = 0;

/* ═══════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════ */
window.addEventListener('DOMContentLoaded', async () => {
  document.getElementById('scanBtn').addEventListener('click', refreshFeeds);
  document.getElementById('viewToggle').addEventListener('click', toggleView);
  document.getElementById('briefBtn').addEventListener('click', generateBrief);
  document.getElementById('briefClose').addEventListener('click', closeBrief);
  document.getElementById('briefHistoryBtn').addEventListener('click', showBriefHistory);
  document.getElementById('briefPrintBtn').addEventListener('click', () => window.print());
  document.getElementById('briefOverlay').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeBrief();
  });
  document.getElementById('sourcesBtn').addEventListener('click', openSources);
  document.getElementById('sourcesClose').addEventListener('click', closeSources);
  document.getElementById('sourcesOverlay').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeSources();
  });
  document.getElementById('suggestBtn').addEventListener('click', suggestSources);
  document.getElementById('addCompetitorBtn').addEventListener('click', addNewCompetitor);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { closeBrief(); closeSources(); }
  });
  buildFeedTabs();
  renderCompetitorCards();
  renderTimeline();
  initRadar();
  initSpider();
  renderSpider();
  setTimeout(() => document.getElementById('loadingOverlay').classList.add('hidden'), 1800);
  await refreshFeeds();
  setInterval(refreshFeeds, 5 * 60 * 1000);
});

/* ═══════════════════════════════════════════
   FEED TABS (safe DOM)
   ═══════════════════════════════════════════ */
function buildFeedTabs() {
  const container = document.getElementById('feedTabs');
  [['all','All Signals'],['competitor','Competitors'],['industry','Industry']].forEach(([key, label]) => {
    const btn = createEl('button', { className: 'feed-tab' + (key === 'all' ? ' active' : '') }, label);
    btn.dataset.filter = key;
    btn.addEventListener('click', () => {
      container.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = key;
      renderFeed();
    });
    container.appendChild(btn);
  });
}

/* ═══════════════════════════════════════════
   RADAR CANVAS
   ═══════════════════════════════════════════ */
function initRadar() {
  const canvas = document.getElementById('radarCanvas');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  const legend = document.getElementById('radarLegend');
  legend.replaceChildren();
  Object.entries(COMPETITORS).forEach(([key, c]) => {
    const dot = createEl('div', { className: 'legend-dot', style: { background: c.color } });
    const item = createEl('div', { className: 'legend-item' }, [dot, c.name]);
    legend.appendChild(item);
  });
  animateRadar();
}

function animateRadar() {
  const canvas = document.getElementById('radarCanvas');
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const cx = w/2, cy = h/2;
  const maxR = Math.min(cx, cy) * 0.88;
  const dpr = window.devicePixelRatio || 1;
  radarAngle += 0.008;
  ctx.clearRect(0, 0, w, h);

  for (let i = 1; i <= 4; i++) {
    const r = maxR * (i/4);
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.strokeStyle = i===4 ? '#1a2740' : '#0f1a2e'; ctx.lineWidth = dpr; ctx.stroke();
  }
  for (let a = 0; a < 6; a++) {
    const angle = (a*Math.PI*2)/6;
    ctx.beginPath(); ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(angle)*maxR, cy + Math.sin(angle)*maxR);
    ctx.strokeStyle = '#0f1a2e'; ctx.lineWidth = dpr; ctx.stroke();
  }
  const sectors = [{a:0,l:'CARRY'},{a:60,l:'BALLISTIC'},{a:120,l:'CLOTHING'},{a:180,l:'INTEGRATION'},{a:240,l:'MEDICAL'},{a:300,l:'DISTRIBUTION'}];
  ctx.font = `${10*dpr}px 'Share Tech Mono', monospace`;
  ctx.fillStyle = '#3e506a'; ctx.textAlign = 'center';
  sectors.forEach(s => {
    const a = ((s.a-90)*Math.PI)/180;
    ctx.fillText(s.l, cx + Math.cos(a)*(maxR+18*dpr), cy + Math.sin(a)*(maxR+18*dpr) + 3*dpr);
  });

  ctx.save(); ctx.translate(cx, cy); ctx.rotate(radarAngle);
  ctx.beginPath(); ctx.moveTo(0, 0); ctx.arc(0, 0, maxR, -0.4, 0); ctx.closePath();
  const sg = ctx.createRadialGradient(0, 0, 0, 0, 0, maxR);
  sg.addColorStop(0, '#00e5a000'); sg.addColorStop(0.3, '#00e5a015'); sg.addColorStop(1, '#00e5a008');
  ctx.fillStyle = sg; ctx.fill();
  ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(maxR, 0);
  ctx.strokeStyle = '#00e5a066'; ctx.lineWidth = 1.5*dpr; ctx.stroke();
  ctx.restore();

  ctx.font = `${8*dpr}px 'Share Tech Mono', monospace`;
  ctx.fillStyle = '#243554'; ctx.textAlign = 'left';
  ['CRITICAL','HIGH','MEDIUM','LOW'].forEach((label, i) => {
    ctx.fillText(label, cx + 6*dpr, cy - maxR*((i+1)/4) + 12*dpr);
  });

  Object.entries(COMPETITORS).forEach(([key, c]) => {
    const angle = ((c.radarAngle-90)*Math.PI)/180;
    const dist = c.radarDist * maxR;
    const bx = cx + Math.cos(angle)*dist, by = cy + Math.sin(angle)*dist;
    const blipAngle = Math.atan2(by-cy, bx-cx);
    let sd = radarAngle - blipAngle;
    while (sd > Math.PI) sd -= Math.PI*2;
    while (sd < -Math.PI) sd += Math.PI*2;
    const near = Math.abs(sd) < 0.5;
    const fade = near ? 1 - Math.abs(sd)/0.5 : 0;
    if (near) {
      const gr = (12 + fade*8)*dpr;
      const glow = ctx.createRadialGradient(bx, by, 0, bx, by, gr);
      glow.addColorStop(0, c.color+'66'); glow.addColorStop(1, c.color+'00');
      ctx.beginPath(); ctx.arc(bx, by, gr, 0, Math.PI*2); ctx.fillStyle = glow; ctx.fill();
    }
    const bs = (c.threat==='high'?5:c.threat==='medium'?4:3)*dpr;
    ctx.beginPath(); ctx.arc(bx, by, bs, 0, Math.PI*2); ctx.fillStyle = c.color; ctx.fill();
    ctx.beginPath(); ctx.arc(bx, by, bs+2*dpr, 0, Math.PI*2);
    ctx.strokeStyle = c.color+'44'; ctx.lineWidth = dpr; ctx.stroke();
    ctx.font = `${9*dpr}px 'Rajdhani', sans-serif`;
    ctx.fillStyle = c.color+'cc'; ctx.textAlign = 'center';
    ctx.fillText(c.name.split(' ')[0], bx, by + bs*1.5 + 12*dpr);
  });

  ctx.beginPath(); ctx.arc(cx, cy, 3*dpr, 0, Math.PI*2);
  ctx.fillStyle = '#00e5a0'; ctx.fill();
  ctx.font = `bold ${10*dpr}px 'Oxanium', sans-serif`;
  ctx.fillStyle = '#00e5a0'; ctx.textAlign = 'center';
  ctx.fillText('SNIGEL', cx, cy + 16*dpr);
  radarAnimFrame = requestAnimationFrame(animateRadar);
}

/* ═══════════════════════════════════════════
   SPIDER CHART
   ═══════════════════════════════════════════ */
function initSpider() {
  const container = document.getElementById('spiderControls');
  container.replaceChildren();
  const sb = createEl('button', { className: 'spider-toggle active', disabled: true });
  sb.style.setProperty('--toggle-color', SNIGEL.color);
  sb.textContent = 'SNIGEL'; sb.style.opacity = '1'; sb.style.cursor = 'default';
  container.appendChild(sb);
  Object.entries(COMPETITORS).forEach(([key, c]) => {
    const btn = createEl('button', { className: 'spider-toggle'+(spiderSelected.includes(key)?' active':'') });
    btn.style.setProperty('--toggle-color', c.color);
    btn.textContent = c.name.split(' ')[0].toUpperCase();
    btn.addEventListener('click', () => {
      if (spiderSelected.includes(key)) { spiderSelected = spiderSelected.filter(k=>k!==key); btn.classList.remove('active'); }
      else if (spiderSelected.length < 4) { spiderSelected.push(key); btn.classList.add('active'); }
      renderSpider();
    });
    container.appendChild(btn);
  });
}

function renderSpider() {
  const canvas = document.getElementById('spiderCanvas');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width*dpr; canvas.height = rect.height*dpr;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height, cx = w/2, cy = h/2;
  const maxR = Math.min(cx, cy)*0.72;
  const axes = Object.keys(CAPABILITY_LABELS);
  const n = axes.length;
  ctx.clearRect(0, 0, w, h);

  for (let ring = 1; ring <= 5; ring++) {
    const r = maxR*(ring/5);
    ctx.beginPath();
    for (let i = 0; i <= n; i++) {
      const a = (i*Math.PI*2)/n - Math.PI/2;
      const x = cx+Math.cos(a)*r, y = cy+Math.sin(a)*r;
      i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.closePath(); ctx.strokeStyle = ring===5?'#1a2740':'#0f1a2e'; ctx.lineWidth = dpr; ctx.stroke();
    if (ring%2===0) { ctx.font=`${8*dpr}px 'Share Tech Mono',monospace`; ctx.fillStyle='#243554'; ctx.textAlign='left'; ctx.fillText(String(ring*2), cx+4*dpr, cy-r+10*dpr); }
  }
  axes.forEach((axis, i) => {
    const a = (i*Math.PI*2)/n - Math.PI/2;
    ctx.beginPath(); ctx.moveTo(cx,cy);
    ctx.lineTo(cx+Math.cos(a)*maxR, cy+Math.sin(a)*maxR);
    ctx.strokeStyle='#0f1a2e'; ctx.lineWidth=dpr; ctx.stroke();
    ctx.font=`${9*dpr}px 'Share Tech Mono',monospace`; ctx.fillStyle='#7a8ba5';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(CAPABILITY_LABELS[axis].toUpperCase(), cx+Math.cos(a)*(maxR+20*dpr), cy+Math.sin(a)*(maxR+20*dpr));
  });

  function drawPoly(caps, color, fa) {
    ctx.beginPath();
    axes.forEach((axis, i) => {
      const v = caps[axis]||0, a = (i*Math.PI*2)/n - Math.PI/2;
      const r = maxR*(v/10), x = cx+Math.cos(a)*r, y = cy+Math.sin(a)*r;
      i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.closePath(); ctx.fillStyle=color+fa; ctx.fill();
    ctx.strokeStyle=color; ctx.lineWidth=2*dpr; ctx.stroke();
    axes.forEach((axis, i) => {
      const v = caps[axis]||0, a = (i*Math.PI*2)/n - Math.PI/2;
      const r = maxR*(v/10), x = cx+Math.cos(a)*r, y = cy+Math.sin(a)*r;
      ctx.beginPath(); ctx.arc(x,y,3*dpr,0,Math.PI*2); ctx.fillStyle=color; ctx.fill();
    });
  }
  spiderSelected.forEach(key => { const c = COMPETITORS[key]; if(c) drawPoly(c.capabilities, c.color, '18'); });
  drawPoly(SNIGEL.capabilities, SNIGEL.color, '22');
}

/* ═══════════════════════════════════════════
   COMPETITOR CARDS (safe DOM)
   ═══════════════════════════════════════════ */
function renderCompetitorCards() {
  const grid = document.getElementById('competitorsGrid');
  grid.replaceChildren();
  Object.entries(COMPETITORS).forEach(([key, c]) => {
    const card = document.createElement('div');
    card.className = 'competitor-card';
    card.style.setProperty('--card-accent', c.color);
    card.addEventListener('click', () => toggleCard(card));

    // Top row
    const top = createEl('div', {className:'card-top'});
    const info = document.createElement('div');
    info.appendChild(createEl('div', {className:'card-name'}, c.name));
    info.appendChild(createEl('div', {className:'card-country'}, `${c.flag} ${c.country} \u00B7 Est. ${c.founded} \u00B7 ${c.hq}`));
    const threat = createEl('span', {className:`card-threat threat-${c.threat}`}, `${c.threat} threat`);
    top.appendChild(info); top.appendChild(threat);

    // Stats
    const stats = createEl('div', {className:'card-stats'});
    [{l:'Revenue',v:c.revenue},{l:'Employees',v:c.employees}].forEach(s => {
      const stat = createEl('div', {className:'card-stat'});
      stat.appendChild(createEl('div', {className:'card-stat-label'}, s.l));
      stat.appendChild(createEl('div', {className:'card-stat-value'}, s.v));
      stats.appendChild(stat);
    });

    // Focus tags
    const focus = createEl('div', {className:'card-focus'});
    c.focus.forEach(f => focus.appendChild(createEl('span', {className:'focus-tag'}, f)));

    // Details (SWOT + timeline)
    const details = createEl('div', {className:'card-details'});
    const swotGrid = createEl('div', {className:'swot-grid'});
    [{cls:'swot-strength',title:'Strengths',text:c.swot.s},{cls:'swot-weakness',title:'Weaknesses',text:c.swot.w},
     {cls:'swot-opportunity',title:'Opportunities',text:c.swot.o},{cls:'swot-threat-cell',title:'Threats',text:c.swot.t}].forEach(sw => {
      const cell = createEl('div', {className:`swot-cell ${sw.cls}`});
      cell.appendChild(createEl('h4', {}, sw.title));
      cell.appendChild(createEl('div', {}, sw.text));
      swotGrid.appendChild(cell);
    });
    details.appendChild(swotGrid);

    const evLabel = createEl('div', {style:{fontFamily:'var(--font-data)',fontSize:'0.65rem',color:'var(--text-dim)',marginBottom:'0.4rem',textTransform:'uppercase',letterSpacing:'0.1em'}}, 'Key Events');
    details.appendChild(evLabel);
    const tl = createEl('div', {className:'card-timeline-mini'});
    c.timeline.forEach(e => {
      const ev = createEl('div', {className:'mini-event'});
      ev.appendChild(createEl('span', {className:'mini-event-date'}, e.date));
      ev.appendChild(createEl('span', {}, e.text));
      tl.appendChild(ev);
    });
    details.appendChild(tl);

    // Live signals section (inside details)
    const signalsSection = createEl('div', {className:'card-signals'});
    signalsSection.dataset.competitorKey = key;
    const signalsHeader = createEl('div', {className:'card-signals-header'});
    signalsHeader.appendChild(document.createTextNode('Latest Signals '));
    signalsHeader.appendChild(createEl('span', {className:'signal-count', id:'signal-count-'+key}, ''));
    signalsSection.appendChild(signalsHeader);
    const signalsList = createEl('div', {id:'card-signals-'+key});
    signalsList.appendChild(createEl('div', {className:'card-no-signals'}, 'Click to load signals...'));
    signalsSection.appendChild(signalsList);
    details.appendChild(signalsSection);

    card.appendChild(top); card.appendChild(stats); card.appendChild(focus); card.appendChild(details);
    grid.appendChild(card);
  });
}

function toggleCard(card) {
  if (expandedCard === card) { card.classList.remove('expanded'); expandedCard = null; }
  else {
    if (expandedCard) expandedCard.classList.remove('expanded');
    card.classList.add('expanded');
    expandedCard = card;
    // Populate live signals for this competitor
    const key = card.querySelector('[data-competitor-key]')?.dataset.competitorKey;
    if (key) populateCardSignals(key);
  }
}

function populateCardSignals(key) {
  const container = document.getElementById('card-signals-' + key);
  const countEl = document.getElementById('signal-count-' + key);
  if (!container) return;
  const data = feedData.competitors[key];
  const items = data?.items || [];
  countEl.textContent = '(' + items.length + ')';
  container.replaceChildren();
  if (items.length === 0) {
    container.appendChild(createEl('div', {className:'card-no-signals'}, 'No signals detected for this competitor.'));
    return;
  }
  items.slice(0, 10).forEach(item => {
    const row = createEl('div', {className:'card-signal'});
    const timeAgo = getTimeAgo(item.pubDate);
    row.appendChild(createEl('div', {className:'card-signal-time'}, timeAgo));
    const textDiv = createEl('div', {className:'card-signal-text'});
    const titleDiv = createEl('div', {className:'card-signal-title'});
    const link = createEl('a', {href: item.link, target:'_blank', rel:'noopener'}, item.title);
    link.addEventListener('click', (e) => e.stopPropagation());
    titleDiv.appendChild(link);
    textDiv.appendChild(titleDiv);
    textDiv.appendChild(createEl('div', {className:'card-signal-source'}, item.source));
    row.appendChild(textDiv);
    container.appendChild(row);
  });
}

/* ═══════════════════════════════════════════
   TIMELINE (safe DOM)
   ═══════════════════════════════════════════ */
function renderTimeline() {
  const list = document.getElementById('timelineList');
  list.replaceChildren();
  STRATEGIC_EVENTS.forEach(evt => {
    const item = createEl('div', {className:'timeline-item'});
    item.style.setProperty('--event-color', evt.color);
    item.appendChild(createEl('div', {className:'timeline-date'}, evt.date));
    item.appendChild(createEl('div', {className:'timeline-company'}, evt.company));
    item.appendChild(createEl('div', {className:'timeline-text'}, evt.text));
    const tag = createEl('span', {className:`timeline-tag tag-${evt.tag}`}, evt.tag.toUpperCase());
    item.appendChild(tag);
    list.appendChild(item);
  });
}

/* ═══════════════════════════════════════════
   FEED MANAGEMENT (safe DOM)
   ═══════════════════════════════════════════ */
async function refreshFeeds() {
  const dot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  dot.classList.add('scanning'); statusText.textContent = 'SCANNING...';
  try {
    const response = await fetch('/api/feeds/all');
    if (!response.ok) throw new Error('Feed fetch failed');
    const result = await response.json();
    feedData.competitors = result.competitors || {};
    feedData.industry = result.industry || [];
    const total = Object.values(feedData.competitors).reduce((s,c)=>s+(c.items?.length||0),0) + feedData.industry.length;
    document.getElementById('feedCount').textContent = `${total} SIGNALS`;
    document.getElementById('lastScan').textContent = `LAST SCAN: ${new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}`;
    renderFeed();
  } catch(err) {
    console.warn('Feed fetch error:', err.message);
    document.getElementById('feedItemCount').textContent = 'Server offline';
    renderFeedOffline();
  }
  dot.classList.remove('scanning'); statusText.textContent = 'ONLINE';
}

function renderFeed() {
  const list = document.getElementById('feedList');
  list.replaceChildren();
  let items = [];
  if (currentFilter==='all'||currentFilter==='competitor') {
    Object.entries(feedData.competitors).forEach(([key, data]) => {
      const c = COMPETITORS[key];
      if (!data.items) return;
      data.items.forEach(item => items.push({...item, competitorKey:key, competitorName:data.name, competitorColor:c?.color||'#64748b', type:'competitor'}));
    });
  }
  if (currentFilter==='all'||currentFilter==='industry') {
    feedData.industry.forEach(item => items.push({...item, competitorKey:'industry', competitorName:'Industry', competitorColor:'#64748b', type:'industry'}));
  }
  items.sort((a,b)=>new Date(b.pubDate)-new Date(a.pubDate));
  items = items.slice(0, 50);
  document.getElementById('feedItemCount').textContent = `${items.length} items`;
  if (items.length === 0) {
    list.appendChild(createEl('div', {className:'feed-empty'}, 'No signals detected in current filter.'));
    return;
  }
  items.forEach(item => {
    const timeAgo = getTimeAgo(item.pubDate);
    const isNew = (Date.now() - new Date(item.pubDate).getTime()) < 86400000;
    const link = createEl('a', { className:'feed-item'+(isNew?' new':''), href: item.link, target:'_blank', rel:'noopener' });
    const tag = createEl('span', {className:'feed-competitor-tag'});
    tag.style.background = item.competitorColor+'22';
    tag.style.color = item.competitorColor;
    tag.style.border = `1px solid ${item.competitorColor}44`;
    tag.textContent = item.competitorName.split(' ')[0];
    const mid = document.createElement('div');
    mid.appendChild(createEl('div', {className:'feed-title'}, item.title));
    mid.appendChild(createEl('div', {className:'feed-source'}, item.source));
    const time = createEl('span', {className:'feed-time'}, timeAgo);
    link.appendChild(tag); link.appendChild(mid); link.appendChild(time);
    list.appendChild(link);
  });
}

function renderFeedOffline() {
  const list = document.getElementById('feedList');
  list.replaceChildren();
  const empty = createEl('div', {className:'feed-empty'});
  empty.appendChild(createEl('div', {style:{fontSize:'1.5rem',marginBottom:'0.8rem',opacity:'0.4'}}, '\u2739'));
  empty.appendChild(createEl('div', {style:{marginBottom:'0.5rem'}}, 'RSS feeds require the backend server'));
  const cmd = createEl('div', {style:{color:'var(--accent-green)',fontFamily:'var(--font-data)',fontSize:'0.75rem'}}, 'cd snigel-radar && npm install && npm start');
  empty.appendChild(cmd);
  empty.appendChild(createEl('div', {style:{marginTop:'1rem',fontSize:'0.7rem',opacity:'0.6'}}, 'Radar, profiles, spider chart, and timeline work offline.'));
  list.appendChild(empty);
}

function getTimeAgo(dateStr) {
  if (!dateStr) return '';
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff/60000);
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins/60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours/24);
  if (days < 7) return `${days}d ago`;
  return new Date(dateStr).toLocaleDateString('en-GB',{day:'numeric',month:'short'});
}

function toggleView() {
  const btn = document.getElementById('viewToggle');
  const grid = document.getElementById('competitorsGrid');
  if (grid.style.gridTemplateColumns === '1fr') { grid.style.gridTemplateColumns = ''; btn.textContent = 'GRID VIEW'; }
  else { grid.style.gridTemplateColumns = '1fr'; btn.textContent = 'LIST VIEW'; }
}

/* ═══════════════════════════════════════════
   AI BRIEF (streaming from Sonnet 4.5)
   ═══════════════════════════════════════════ */
let briefAbortController = null;

function closeBrief() {
  document.getElementById('briefOverlay').classList.remove('visible');
  if (briefAbortController) { briefAbortController.abort(); briefAbortController = null; }
}

function markdownToHtml(md) {
  // Simple markdown to safe HTML (no innerHTML with user content - only our AI output)
  return md
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^\- \*\*(.+?)\*\*:?\s*/gm, '<li><strong>$1</strong> ')
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/<\/li>\s*<li>/g, '</li><li>')
    .replace(/(<li>[\s\S]*?<\/li>)/g, (match) => {
      if (!match.startsWith('<ul>')) return '<ul>' + match + '</ul>';
      return match;
    })
    .replace(/<\/ul>\s*<ul>/g, '');
}

async function generateBrief() {
  const overlay = document.getElementById('briefOverlay');
  const content = document.getElementById('briefContent');
  const status = document.getElementById('briefStatus');
  const usage = document.getElementById('briefUsage');

  overlay.classList.add('visible');
  content.textContent = '';
  usage.textContent = '';

  const spinner = createEl('div', {className:'spinner'});
  status.replaceChildren(spinner, document.createTextNode('Generating brief...'));

  briefAbortController = new AbortController();
  let rawText = '';

  try {
    const response = await fetch('/api/brief', { signal: briefAbortController.signal });

    if (!response.ok) {
      const err = await response.json().catch(() => ({ error: 'Server error' }));
      content.textContent = err.error || 'Failed to generate brief. Is ANTHROPIC_API_KEY set?';
      status.textContent = '';
      return;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const json = line.slice(6);
        let event;
        try { event = JSON.parse(json); } catch { continue; }

        if (event.type === 'delta') {
          rawText += event.text;
          // Render markdown as we go - use a safe container
          const rendered = markdownToHtml(rawText);
          // Create a safe rendering container
          const temp = document.createElement('div');
          temp.className = 'brief-content';
          temp.innerHTML = rendered + '<span class="brief-cursor"></span>';
          content.replaceChildren(...temp.childNodes);
        } else if (event.type === 'done') {
          // Final render without cursor
          const rendered = markdownToHtml(rawText);
          const temp = document.createElement('div');
          temp.className = 'brief-content';
          temp.innerHTML = rendered;
          content.replaceChildren(...temp.childNodes);
          status.textContent = 'Complete';
          if (event.usage) {
            usage.textContent = `${event.usage.input_tokens} in / ${event.usage.output_tokens} out tokens`;
          }
        } else if (event.type === 'error') {
          status.textContent = '';
          const errEl = createEl('div', {style:{color:'var(--accent-red)',marginTop:'1rem'}}, event.error);
          content.appendChild(errEl);
        }
      }
    }
  } catch (err) {
    if (err.name !== 'AbortError') {
      status.textContent = '';
      content.textContent = 'Connection error: ' + err.message;
    }
  }

  briefAbortController = null;
  // Brief was generated, no additional save needed — server handles persistence
}

async function showBriefHistory() {
  const content = document.getElementById('briefContent');
  const status = document.getElementById('briefStatus');
  const usage = document.getElementById('briefUsage');
  status.textContent = '';
  usage.textContent = '';

  content.replaceChildren(createEl('div', {className:'suggest-spinner'}, [
    createEl('div', {className:'spinner'}), document.createTextNode('Loading brief history...')
  ]));

  try {
    const res = await fetch('/api/briefs');
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);

    content.replaceChildren();
    if (json.briefs.length === 0) {
      content.appendChild(createEl('div', {className:'card-no-signals'}, 'No briefs generated yet. Click "AI BRIEF" and then "Generate" to create one.'));
      return;
    }

    const header = createEl('div', {style:{fontFamily:'var(--font-data)',fontSize:'0.7rem',color:'var(--text-dim)',marginBottom:'0.8rem',textTransform:'uppercase',letterSpacing:'0.1em'}}, json.briefs.length + ' saved briefs — click to view');
    content.appendChild(header);

    const list = createEl('div', {className:'brief-history-list'});
    json.briefs.forEach(b => {
      const item = createEl('div', {className:'brief-history-item'});
      const date = new Date(b.timestamp);
      const dateStr = date.toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) + ' ' + date.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'});
      item.appendChild(createEl('div', {className:'brief-history-date'}, dateStr));
      item.appendChild(createEl('div', {className:'brief-history-preview'}, b.preview));
      const tokens = b.usage ? (b.usage.input_tokens + '/' + b.usage.output_tokens) : '';
      item.appendChild(createEl('div', {className:'brief-history-tokens'}, tokens));
      item.addEventListener('click', () => loadBrief(b.id));
      list.appendChild(item);
    });
    content.appendChild(list);
  } catch (err) {
    content.replaceChildren(createEl('div', {style:{color:'var(--accent-red)',padding:'1rem',fontFamily:'var(--font-data)'}}, 'Error: ' + err.message));
  }
}

async function loadBrief(id) {
  const content = document.getElementById('briefContent');
  const status = document.getElementById('briefStatus');
  const usage = document.getElementById('briefUsage');

  content.replaceChildren(createEl('div', {className:'suggest-spinner'}, [
    createEl('div', {className:'spinner'}), document.createTextNode('Loading...')
  ]));

  try {
    const res = await fetch('/api/briefs/' + encodeURIComponent(id));
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);

    const rendered = markdownToHtml(json.brief.text);
    const temp = document.createElement('div');
    temp.className = 'brief-content';
    temp.innerHTML = rendered;
    content.replaceChildren(...temp.childNodes);

    const date = new Date(json.brief.timestamp);
    status.textContent = 'Brief from ' + date.toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'});
    if (json.brief.usage) {
      usage.textContent = json.brief.usage.input_tokens + ' in / ' + json.brief.usage.output_tokens + ' out tokens';
    }
  } catch (err) {
    content.replaceChildren(createEl('div', {style:{color:'var(--accent-red)',fontFamily:'var(--font-data)'}}, 'Error loading brief: ' + err.message));
  }
}

/* ═══════════════════════════════════════════
   SOURCES MANAGEMENT
   ═══════════════════════════════════════════ */
let sourcesData = null;

function closeSources() {
  document.getElementById('sourcesOverlay').classList.remove('visible');
}

async function openSources() {
  const overlay = document.getElementById('sourcesOverlay');
  const body = document.getElementById('sourcesBody');
  overlay.classList.add('visible');
  body.replaceChildren(createEl('div', {className:'suggest-spinner'}, [
    createEl('div', {className:'spinner'}), document.createTextNode('Loading sources...')
  ]));

  try {
    const res = await fetch('/api/sources');
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);
    sourcesData = json.sources;
    renderSources();
  } catch (err) {
    body.replaceChildren(createEl('div', {style:{color:'var(--accent-red)',padding:'1rem',fontFamily:'var(--font-data)'}}, 'Failed to load sources: ' + err.message));
  }
}

function renderSources() {
  const body = document.getElementById('sourcesBody');
  body.replaceChildren();

  // Competitor section
  const compSection = createEl('div', {className:'sources-section'});
  const compHeader = createEl('div', {className:'sources-section-header'});
  compHeader.appendChild(createEl('div', {className:'sources-section-title'}, 'Competitor Feeds'));
  compHeader.appendChild(createEl('div', {className:'sources-count'}, Object.keys(sourcesData.competitors).length + ' competitors'));
  compSection.appendChild(compHeader);

  Object.entries(sourcesData.competitors).forEach(([key, comp]) => {
    const group = createEl('div', {className:'source-group'});
    const header = createEl('div', {className:'source-group-header'});
    const nameDiv = document.createElement('div');
    nameDiv.appendChild(createEl('span', {className:'source-group-name'}, comp.name));
    nameDiv.appendChild(createEl('span', {className:'source-group-meta'}, '  ' + comp.feeds.length + ' feeds \u00B7 ' + key));
    header.appendChild(nameDiv);

    const actions = createEl('div', {className:'source-group-actions'});
    const delBtn = createEl('button', {className:'source-btn danger'}, 'DELETE');
    delBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteCompetitor(key, comp.name); });
    actions.appendChild(delBtn);
    header.appendChild(actions);

    header.addEventListener('click', () => group.classList.toggle('expanded'));

    const feedList = createEl('div', {className:'source-feed-list'});
    comp.feeds.forEach((url, idx) => {
      const feedRow = createEl('div', {className:'source-feed'});
      feedRow.appendChild(createEl('span', {className:'source-feed-url'}, url));
      const rmBtn = createEl('button', {className:'source-btn danger'}, '\u00D7');
      rmBtn.addEventListener('click', (e) => { e.stopPropagation(); removeFeed(key, idx); });
      feedRow.appendChild(rmBtn);
      feedList.appendChild(feedRow);
    });

    // Add feed row
    const addRow = createEl('div', {className:'source-add-row'});
    const input = createEl('input', {className:'source-input', type:'text', placeholder:'Add RSS feed URL...'});
    const addBtn = createEl('button', {className:'source-btn primary'}, '+ ADD');
    addBtn.addEventListener('click', () => { if (input.value.trim()) addFeedToCompetitor(key, input.value.trim()); });
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && input.value.trim()) addFeedToCompetitor(key, input.value.trim()); });
    addRow.appendChild(input);
    addRow.appendChild(addBtn);
    feedList.appendChild(addRow);

    group.appendChild(header);
    group.appendChild(feedList);
    compSection.appendChild(group);
  });
  body.appendChild(compSection);

  // Industry section
  const indSection = createEl('div', {className:'sources-section'});
  const indHeader = createEl('div', {className:'sources-section-header'});
  indHeader.appendChild(createEl('div', {className:'sources-section-title'}, 'Industry Feeds'));
  indHeader.appendChild(createEl('div', {className:'sources-count'}, sourcesData.industry.length + ' feeds'));
  indSection.appendChild(indHeader);

  sourcesData.industry.forEach((url, idx) => {
    const feedRow = createEl('div', {className:'source-feed', style:{background:'var(--bg-card)',borderRadius:'3px',marginBottom:'2px',border:'1px solid var(--border)'}});
    feedRow.appendChild(createEl('span', {className:'source-feed-url'}, url));
    const rmBtn = createEl('button', {className:'source-btn danger'}, '\u00D7');
    rmBtn.addEventListener('click', () => removeIndustryFeed(url));
    feedRow.appendChild(rmBtn);
    indSection.appendChild(feedRow);
  });

  const addRow = createEl('div', {className:'source-add-row', style:{padding:'0.6rem 0'}});
  const input = createEl('input', {className:'source-input', type:'text', placeholder:'Add industry RSS feed URL...'});
  const addBtn = createEl('button', {className:'source-btn primary'}, '+ ADD');
  addBtn.addEventListener('click', () => { if (input.value.trim()) addIndustryFeed(input.value.trim()); });
  input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && input.value.trim()) addIndustryFeed(input.value.trim()); });
  addRow.appendChild(input);
  addRow.appendChild(addBtn);
  indSection.appendChild(addRow);
  body.appendChild(indSection);

  // AI suggestions container
  const suggestSection = createEl('div', {className:'sources-section'});
  suggestSection.id = 'suggestSection';
  body.appendChild(suggestSection);
}

async function deleteCompetitor(key, name) {
  if (!confirm('Remove ' + name + ' and all its feeds?')) return;
  setSourcesStatus('Removing...');
  try {
    const res = await fetch('/api/sources/competitor/' + encodeURIComponent(key), { method: 'DELETE' });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);
    delete sourcesData.competitors[key];
    renderSources();
    setSourcesStatus('Removed ' + name);
  } catch (err) { setSourcesStatus('Error: ' + err.message); }
}

async function removeFeed(compKey, feedIdx) {
  sourcesData.competitors[compKey].feeds.splice(feedIdx, 1);
  setSourcesStatus('Saving...');
  try {
    const res = await fetch('/api/sources', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(sourcesData) });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);
    renderSources();
    setSourcesStatus('Feed removed');
  } catch (err) { setSourcesStatus('Error: ' + err.message); }
}

async function addFeedToCompetitor(compKey, url) {
  sourcesData.competitors[compKey].feeds.push(url);
  setSourcesStatus('Saving...');
  try {
    const res = await fetch('/api/sources', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(sourcesData) });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);
    renderSources();
    setSourcesStatus('Feed added');
  } catch (err) { setSourcesStatus('Error: ' + err.message); }
}

async function addIndustryFeed(url) {
  setSourcesStatus('Adding...');
  try {
    const res = await fetch('/api/sources/add-industry', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ url }) });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);
    sourcesData.industry.push(url);
    renderSources();
    setSourcesStatus('Industry feed added');
  } catch (err) { setSourcesStatus('Error: ' + err.message); }
}

async function removeIndustryFeed(url) {
  setSourcesStatus('Removing...');
  try {
    const res = await fetch('/api/sources/industry', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ url }) });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);
    sourcesData.industry = sourcesData.industry.filter(u => u !== url);
    renderSources();
    setSourcesStatus('Industry feed removed');
  } catch (err) { setSourcesStatus('Error: ' + err.message); }
}

function addNewCompetitor() {
  const name = prompt('Competitor display name (e.g. "Arktis Ltd"):');
  if (!name) return;
  const key = name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
  const feedUrl = prompt('First RSS feed URL (you can add more later):');
  if (!feedUrl) return;

  setSourcesStatus('Adding...');
  fetch('/api/sources/add-competitor', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ key, name, feeds: [feedUrl] })
  }).then(r => r.json()).then(json => {
    if (!json.ok) throw new Error(json.error);
    sourcesData.competitors[json.key] = { name, feeds: [feedUrl] };
    renderSources();
    setSourcesStatus('Added ' + name);
  }).catch(err => setSourcesStatus('Error: ' + err.message));
}

async function suggestSources() {
  const section = document.getElementById('suggestSection');
  section.replaceChildren(
    createEl('div', {className:'sources-section-header'}, [
      createEl('div', {className:'sources-section-title', style:{color:'var(--accent-purple)'}}, 'AI Suggestions')
    ]),
    createEl('div', {className:'suggest-spinner'}, [
      createEl('div', {className:'spinner', style:{borderTopColor:'var(--accent-purple)'}}),
      document.createTextNode('Analyzing coverage gaps with Sonnet 4.5...')
    ])
  );

  try {
    const res = await fetch('/api/sources/suggest', { method: 'POST', headers: {'Content-Type':'application/json'}, body: '{}' });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || 'AI suggestion failed');

    section.replaceChildren(
      createEl('div', {className:'sources-section-header'}, [
        createEl('div', {className:'sources-section-title', style:{color:'var(--accent-purple)'}}, 'AI Suggestions'),
        createEl('div', {className:'sources-count'}, json.suggestions.length + ' suggestions \u00B7 ' + (json.usage?.input_tokens || 0) + '/' + (json.usage?.output_tokens || 0) + ' tokens')
      ])
    );

    const list = createEl('div', {className:'suggest-list'});
    json.suggestions.forEach(s => {
      const item = createEl('div', {className:'suggest-item'});
      const body = createEl('div', {className:'suggest-item-body'});
      const typeLabel = s.type === 'competitor' ? (s.name || s.key) + ' (competitor)' : 'Industry';
      body.appendChild(createEl('div', {className:'suggest-item-meta'}, typeLabel));
      body.appendChild(createEl('div', {className:'suggest-item-url'}, s.url));
      body.appendChild(createEl('div', {className:'suggest-item-reason'}, s.reason));

      const actions = createEl('div', {className:'suggest-item-actions'});
      const acceptBtn = createEl('button', {className:'source-btn primary'}, 'ACCEPT');
      acceptBtn.addEventListener('click', () => acceptSuggestion(s, acceptBtn));
      actions.appendChild(acceptBtn);
      item.appendChild(body);
      item.appendChild(actions);
      list.appendChild(item);
    });
    section.appendChild(list);
  } catch (err) {
    section.replaceChildren(
      createEl('div', {style:{color:'var(--accent-red)',padding:'1rem',fontFamily:'var(--font-data)'}}, 'Suggestion error: ' + err.message)
    );
  }
}

async function acceptSuggestion(suggestion, btn) {
  btn.textContent = '...';
  btn.disabled = true;
  try {
    if (suggestion.type === 'competitor') {
      const key = suggestion.key || suggestion.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
      if (sourcesData.competitors[key]) {
        // Add feed to existing competitor
        sourcesData.competitors[key].feeds.push(suggestion.url);
        await fetch('/api/sources', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(sourcesData) });
      } else {
        // Create new competitor
        await fetch('/api/sources/add-competitor', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ key, name: suggestion.name || key, feeds: [suggestion.url] })
        });
        sourcesData.competitors[key] = { name: suggestion.name || key, feeds: [suggestion.url] };
      }
    } else {
      await fetch('/api/sources/add-industry', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ url: suggestion.url })
      });
      sourcesData.industry.push(suggestion.url);
    }
    btn.textContent = 'ADDED';
    btn.style.borderColor = 'var(--accent-green)';
    btn.style.color = 'var(--accent-green)';
    renderSources();
    setSourcesStatus('Source accepted');
  } catch (err) {
    btn.textContent = 'ERROR';
    btn.style.color = 'var(--accent-red)';
  }
}

function setSourcesStatus(msg) {
  const el = document.getElementById('sourcesStatus');
  el.textContent = msg;
  setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 3000);
}

let resizeTimer;
window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(() => { cancelAnimationFrame(radarAnimFrame); initRadar(); renderSpider(); }, 250); });
</script>
</body>
</html>
